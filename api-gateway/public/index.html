<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Platform Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
        }

        .card {
            background-color: #1e1e1e;
            border: 1px solid #333;
            color: #e0e0e0;
        }

        .form-control,
        .form-select {
            background-color: #2c2c2c;
            border-color: #444;
            color: #fff;
        }

        .form-control:focus,
        .form-select:focus {
            background-color: #333;
            border-color: #666;
            color: #fff;
        }

        .btn-primary {
            background-color: #0d6efd;
            border: none;
        }

        #output-container {
            min-height: 200px;
            border: 1px dashed #444;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
        }

        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>

<body class="p-4">
    <div class="container">
        <h1 class="mb-4 text-center">AI Platform Manager</h1>

        <div class="row">
            <!-- Download Section -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Download Models</h5>
                        <div class="mb-3">
                            <label class="form-label">Model Type</label>
                            <select id="dl-type" class="form-select">
                                <option value="text">Text (Ollama Library)</option>
                                <option value="image">Image / UNET (GGUF/Safetensors)</option>
                                <option value="clip">CLIP (Text Encoder)</option>
                                <option value="vae">VAE</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Model Name / Name for local save</label>
                            <input type="text" id="dl-name" class="form-control"
                                placeholder="e.g., qwen2.5 or custom_sdxl.safetensors">
                        </div>
                        <div class="mb-3" id="url-container" style="display:none;">
                            <label class="form-label">Hugging Face Download URL</label>
                            <input type="text" id="dl-url" class="form-control"
                                placeholder="https://huggingface.co/.../model.safetensors">
                        </div>
                        <button onclick="downloadModel()" class="btn btn-primary w-100">Download</button>
                        <div id="dl-status" class="mt-2 small"></div>
                    </div>
                </div>
            </div>

            <!-- Testing Section -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Test Models</h5>
                        <div class="mb-3">
                            <label class="form-label">Category</label>
                            <select id="test-category" class="form-select" onchange="updateModelList()">
                                <option value="text">Text Generation</option>
                                <option value="embeddings">Embeddings</option>
                                <option value="image">Image Generation</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Select Model (Diffusion/GGUF)</label>
                            <select id="test-model" class="form-select">
                                <option>Loading models...</option>
                            </select>
                        </div>
                        <div id="image-advanced-configs" style="display:none;">
                            <div class="mb-3">
                                <label class="form-label">Base Model (for internal CLIP/VAE)</label>
                                <select id="base-model" class="form-select">
                                    <option>Loading models...</option>
                                </select>
                                <small class="text-muted">Pick a model with compatible CLIP (e.g., SDXL for SDXL
                                    GGUFs).</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Override CLIP (Optional)</label>
                                <select id="clip-model" class="form-select">
                                    <option value="">None (Use Base Model)</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Override VAE (Optional)</label>
                                <select id="vae-model" class="form-select">
                                    <option value="">None (Use Base Model)</option>
                                </select>
                            </div>
                        </div>
                        <div id="lumina-warning" class="alert alert-info mt-2 small" style="display:none;">
                            <strong>Lumina2 Settings:</strong> This model needs a 16-channel VAE and a specific CLIP
                            (Gemma).
                            <div class="mt-1">
                                <button onclick="prefillLuminaVAE()" class="btn btn-sm btn-primary py-0"
                                    style="font-size: 0.7rem;">Download VAE</button>
                                <button onclick="prefillLuminaCLIP()" class="btn btn-sm btn-secondary py-0"
                                    style="font-size: 0.7rem;">Download CLIP</button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Prompt</label>
                            <textarea id="test-prompt" class="form-control" rows="3"
                                placeholder="Enter your prompt here..."></textarea>
                        </div>
                        <button onclick="runTest()" id="btn-generate" class="btn btn-success w-100">Generate</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Result</h5>
                        <div id="output-container" class="text-center">
                            <div id="loading" style="display:none;" class="spinner-border text-primary" role="status">
                            </div>
                            <div id="result-content">Results will appear here...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_KEY = '8b4f5d6e-7c8d-9e0f-1523-3a4f3d2l7a8c';
        let models = { text: [], image: [], clip: [], vae: [] };

        async function fetchModels() {
            try {
                const res = await fetch('/models', {
                    headers: {
                        'X-Api-Key': API_KEY
                    }
                });
                models = await res.json();
                updateModelList();
            } catch (e) {
                console.error("Error fetching models", e);
            }
        }

        function updateModelList() {
            const category = document.getElementById('test-category').value;
            const select = document.getElementById('test-model');
            const baseSelect = document.getElementById('base-model');
            const clipSelect = document.getElementById('clip-model');
            const vaeSelect = document.getElementById('vae-model');
            const advancedConfigs = document.getElementById('image-advanced-configs');

            select.innerHTML = '';
            baseSelect.innerHTML = '';
            clipSelect.innerHTML = '<option value="">None (Use Base Model)</option>';
            vaeSelect.innerHTML = '<option value="">None (Use Base Model)</option>';

            const list = (category === 'embeddings' ? models.text : models[category]) || [];
            list.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.textContent = m;
                select.appendChild(opt);
            });

            if (category === 'image') {
                advancedConfigs.style.display = 'block';
                // Base models (safetensors)
                const baseList = list.filter(m => !m.endsWith('.gguf'));
                baseList.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m;
                    opt.textContent = m;
                    baseSelect.appendChild(opt);
                });
                // Clips
                (models.clip || []).forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m;
                    opt.textContent = m;
                    clipSelect.appendChild(opt);
                });
                // Vaes
                (models.vae || []).forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m;
                    opt.textContent = m;
                    vaeSelect.appendChild(opt);
                });
            } else {
                advancedConfigs.style.display = 'none';
            }

            // Check for Lumina2/z-image
            const luminaWarning = document.getElementById('lumina-warning');
            if (category === 'image' && model.toLowerCase().includes('z-image')) {
                luminaWarning.style.display = 'block';
            } else {
                luminaWarning.style.display = 'none';
            }

            if (list.length === 0) {
                const opt = document.createElement('option');
                opt.textContent = "No models found";
                select.appendChild(opt);
            }
        }

        function prefillLuminaVAE() {
            document.getElementById('dl-type').value = 'vae';
            document.getElementById('dl-name').value = 'lumina2_vae_fp16.safetensors';
            document.getElementById('dl-url').value = 'https://huggingface.co/calcuis/lumina-gguf/resolve/main/lumina2_vae_fp16.safetensors';
            document.getElementById('url-container').style.display = 'block';
            window.scrollTo(0, 0);
        }

        function prefillLuminaCLIP() {
            document.getElementById('dl-type').value = 'clip';
            document.getElementById('dl-name').value = 'gemma-2-2b-it.gguf';
            document.getElementById('dl-url').value = 'https://huggingface.co/calcuis/lumina-gguf/resolve/main/gemma-2-2b-it.gguf';
            document.getElementById('url-container').style.display = 'block';
            window.scrollTo(0, 0);
        }

        document.getElementById('dl-type').onchange = function () {
            document.getElementById('url-container').style.display = this.value !== 'text' ? 'block' : 'none';
        };

        async function downloadModel() {
            const type = document.getElementById('dl-type').value;
            const name = document.getElementById('dl-name').value;
            const url = document.getElementById('dl-url').value;
            const status = document.getElementById('dl-status');

            status.textContent = "Starting download...";
            try {
                const res = await fetch('/models/download?api_key=' + API_KEY, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type, name, url })
                });
                const data = await res.json();
                status.textContent = data.message || data.error;
                fetchModels();
            } catch (e) {
                status.textContent = "Error: " + e.message;
            }
        }

        async function runTest() {
            const category = document.getElementById('test-category').value;
            const model = document.getElementById('test-model').value;
            const base_model = document.getElementById('base-model').value;
            const clip_model = document.getElementById('clip-model').value;
            const vae_model = document.getElementById('vae-model').value;
            const prompt = document.getElementById('test-prompt').value;

            const btn = document.getElementById('btn-generate');
            const loading = document.getElementById('loading');
            const content = document.getElementById('result-content');

            btn.disabled = true;
            loading.style.display = 'inline-block';
            content.innerHTML = '';

            try {
                let endpoint;
                if (category === 'text') endpoint = '/text/gen';
                else if (category === 'embeddings') endpoint = '/text/embeddings';
                else endpoint = '/image/gen';

                const res = await fetch(endpoint + '?api_key=' + API_KEY, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, model, base_model, clip_model, vae_model })
                });
                const data = await res.json();

                if (category === 'text') {
                    content.innerHTML = `<pre class="text-start">${data.response || JSON.stringify(data, null, 2)}</pre>`;
                } else if (category === 'embeddings') {
                    content.innerHTML = `<p>Embedding generated successfully.</p><pre class="text-start" style="max-height: 300px; overflow-y: auto;">${JSON.stringify(data.embedding, null, 2)}</pre>`;
                } else {
                    if (data.image) {
                        content.innerHTML = `<img src="${data.image}" class="img-fluid" />`;
                    } else if (data.error) {
                        content.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                    } else {
                        content.innerHTML = `<p>Image generation started. ID: ${data.prompt_id}. Please wait a few seconds and check storage/gateway/output.</p>`;
                    }
                }
            } catch (e) {
                content.innerHTML = `<div class="alert alert-danger">Error: ${e.message}</div>`;
            } finally {
                btn.disabled = false;
                loading.style.display = 'none';
            }
        }

        // Initial fetch
        fetchModels();
    </script>
</body>

</html>